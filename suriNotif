#!/usr/bin/env bash

# God Mode: On
set -o nounset      # Exit on undefined variable
set -o errexit      # Exit on non-zero status
set -o pipefail     # Pipe return exit status


while [[ ! -f "$_PROJECT_ACTIVE_LOG/eve.json" ]] ; do
    [[ -f "$_PROJECT_ACTIVE_LOG/eve.json" ]] && break
    d3bug info "Waiting for a log output"
    sleep 5
done >/dev/null 2>&1

readConfigFile timeout


tail -f "$_PROJECT_ACTIVE_LOG/eve.json" > >( \
  jq --unbuffered -r -c 'select(.event_type=="alert")' \
    | jq --unbuffered -r '@sh  "sid=\(.alert.signature_id) category=\(.alert.category) signature=\(.alert.signature) SRC=\(.src_ip) DEST=\(.dest_ip)  action=\(.alert.action)"' \
      | while read -r line; do \
        eval "$line" ; \
        notify-send -i $_PROJECT_ICON \
          -t $(($configTimeout * 1000 )) \
          "$category" \
          "$(echo -e "Signature: $signature \nSID: $sid \nSource: $SRC \nDestination: $DEST  \nAction: $action")" ; \
      done )
