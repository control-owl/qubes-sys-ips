#!/usr/bin/env bash
#
# coder: ro0t
# stamp: 0.211126-blackfriday

# God Mode: On
set -o nounset      # Exit on undefined variable
set -o errexit      # Exit on non-zero status
set -o pipefail     # Pipe return exit status

trap 'echo "$BASH_COMMAND" failed with error code $?' ERR


function createDir() {
  [[ ! -d "$1" ]] && mkdir -p "$1" || return 0
}
export -f createDir

export dateShort=$(date +"%H:%M:%S")
export dateLong=$(date +"%Y-%m-%d-%H-%M-%S")


export _PROJECT_NAME="suriGUI" && echo -e "$dateShort \e[42;30m$_PROJECT_NAME\e[0m"

export _PROJECT_VER="0.4"
export _PROJECT_BUILD="2021-11-30"
export _PROJECT_DIR="/usr/share/suriGUI"        && createDir "${_##*=}"
export _PROJECT_DIR_RES="$_PROJECT_DIR/res"     && createDir "${_##*=}"
export _PROJECT_DIR_TMP="$_PROJECT_DIR/tmp"     && createDir "${_##*=}"
export _PROJECT_DIR_CONF="$_PROJECT_DIR/conf"   && createDir "${_##*=}"
export _PROJECT_DIR_LOG="$_PROJECT_DIR/log"     && createDir "${_##*=}"

export _PROJECT_ICON_INACTIVE="$_PROJECT_DIR_RES/inactive-icon.png"
export _PROJECT_ICON_ACTIVE="$_PROJECT_DIR_RES/active-icon.png"
export _PROJECT_PIPE="$_PROJECT_DIR_TMP/suri.pipe"

export _SURICATA_CONFIG="$_PROJECT_DIR_CONF/suricata.yaml"
export _SURICATA_CONFIG_IPS="$_PROJECT_DIR_CONF/ips.yaml"
export _SURICATA_RULES="$_PROJECT_DIR_CONF/suricata.rules"
export _SURICATA_LOG="$_PROJECT_DIR_LOG/$_PROJECT_NAME-$dateLong.log"
export _SURICATA_UPDATE_TIMESTAMP="$_SURICATA_RULES.timestamp"
export _SURICATA_OUTDATE="14"



function exitSuriGUI() {
  [[ -e $_PROJECT_PIPE ]] && rm "$_PROJECT_PIPE"

  echo -e "$dateShort \e[41;30mEXIT\e[0m"
  pkill -f "$_PROJECT_NAME-$_PROJECT_VER"
}
export -f exitSuriGUI
trap exitSuriGUI SIGINT SIGTERM EXIT


function createProjectPipe() {
  d3bug

  [[ -e $_PROJECT_PIPE ]] && rm "$_PROJECT_PIPE"

  if mkfifo "$_PROJECT_PIPE" ; then
    d3bug info "Pipe created"
  else
    d3bug error "Can't create pipe"
    exit 1
  fi

  exec 3<> "$_PROJECT_PIPE" && d3bug info "Pipe started"
}
export -f createProjectPipe


function d3bug() {
  d=$(date +"%H:%M:%S")

  case "${3:-*}" in
    "next" )    level="|    |__" ;;
    *)          level="|__" ;;
  esac

  case "${1:-*}" in
    "info" )    echo "$dateShort |   $level $2" ;;
    "error" )   echo -e "$dateShort $level \e[41;30m$2\e[0m" ;;
    *)          echo "$dateShort $level ${FUNCNAME[1]}" ;;
  esac
}
export -f d3bug




function suriGUISettings() {
  d3bug

  KEY=$RANDOM

  yad --plug=$KEY --tabnum=1 --form \
      --field=$"Title:" "${title:-Terminal}" &

  yad --plug=$KEY --tabnum=2 --form  \
      --field=":LBL" "" \
      --field="<b>Mode</b>:LBL" "" \
      --field="Suricata mode":CB "IDS\!^IPS" \
      \
      --field=":LBL" "" \
      --field="<b>Files</b>:LBL" "" \
      --field="Suricata config file:":FL "$_SURICATA_CONFIG" \
      --field="IPS config file:":FL "$_SURICATA_CONFIG_IPS" \
      --field="Suricata rules:":FL "$_SURICATA_RULES" \
      \
      --field=":LBL" "" \
      --field="<b>Actions</b>:LBL" "" \
      --field="Default rule action":CB "alert\!pass\!drop\!reject\!rejectsrc\!rejectdst\!^rejectboth" \
      \ #backup rules files
      --field="rejectboth \\t send RST/ICMP error packets to both sides of the conversation.:LBL" "" \
      \
      --field=":LBL" "" \
      --field="<b>Log</b>:LBL" "" \
      --field="Log directory:":dir "$_PROJECT_DIR_LOG" \
      --field="Persistant log":chk "TRUE" \
      \
      --file-filter="Yaml files (*.yaml)| *.yaml" --file-filter="Config Files (*.cfg *.conf)| *.cfg *.conf" \
      --file-filter="All Files | *.*" &


  TXT=$"  <b>$_PROJECT_NAME</b>   Version: <b>$_PROJECT_VER</b>    Build: <b>$_PROJECT_BUILD</b>\\n\\n"
  TXT+=$"  OS: $(lsb_release -ds) on $(hostname)\\n"
  TXT+=$"  Kernel: $(uname -sr)\\n\\n"
  TXT+="  <i>$(uptime)</i>"

  yad --notebook --width=600 --height=450 --center  \
      --title=$"suriGUI Settings" --text="$TXT" \
      --window-icon="utilities-terminal" --image="utilities-terminal" --image-on-top \
      --button="Cancel" --button="Save":"bash -c suricataSaveSettings" \
      --key=$KEY --tab=$"suriGUI" --tab=$"Suricata" --active-tab=${1:-1}

#      --button="Cancel":"firefox" --button="Save":"bash -c announce" \

}
export -f suriGUISettings


function suriOnClick() {
  d3bug

  #echo "clicked"
  #echo "quit" >&3
  #exec 3<>$_PROJECT_PIPE echo "icon:gtk-help" >&3 &
  suriGUISettings

}
export -f suriOnClick


function stopSuricataService() {
  d3bug

  if systemctl stop suricata ; then
    d3bug info "Suricata service stopped"
  else
    d3bug error "Can't stop Suricata service"
    exit 1
  fi

  updateTrayMenu inactive

}
export -f stopSuricataService


function startSuricataService() {
  d3bug
#
#
#
#
#
#
#
#
  #start suricata service based on my Settings
  #
  #
  #
  #
  #
  #
  #


  case $(systemctl is-active suricata) in
    active )
      d3bug info "Suricata service already running"
      updateTrayMenu active
      ;;
    *)
      systemctl start suricata && sleep 5
      if [[ ! $(systemctl is-active suricata) == "active" ]]; then
        d3bug error "Error starting Suricata service"
        updateTrayMenu inactive
      fi
    ;;
  esac

}
export -f startSuricataService


function updateTrayIcon() {
  d3bug

  exec 3<>$_PROJECT_PIPE echo "icon:$_PROJECT_NAME-$1" >&3 &

  d3bug info "Tray icon updated"

}
export -f updateTrayIcon


function updateTrayMenu() {
  d3bug

  case "$*" in
    "active") menu="Stop!bash -c stopSuricataService" ;;
    "inactive") menu="Start!bash -c startSuricataService" ;;
    *)    exit 1          ;;
  esac


  menu+="|Status!bash -c checkSuricataService||Settings!bash -c suriGUISettings"
  menu+="||Exit!bash -c exitSuriGUI"

  exec 3<>$_PROJECT_PIPE echo "menu:$menu" >&3 &

  d3bug info "Menu updated"

  updateTrayIcon $1
}
export -f updateTrayMenu


function checkSuricataService() {
  d3bug

  case $(systemctl is-active suricata) in
    active )
      d3bug info "Suricata service is active"
      updateTrayMenu active
      export suricataServiceStatus=active
    ;;
    * )
      d3bug info "Suricata service: inactive"
      updateTrayMenu inactive
      export suricataServiceStatus=inactive
    ;;
  esac

}
export -f checkSuricataService


function updateSuricataRules() {
  d3bug

  # create gui window which asks user do they want to update

  if ping -q -c 1 -W 1 github.com >/dev/null ; then
    d3bug info "Internet connection active."
  else
    d3bug error "No internet connection. Trying Qubes Proxy..."

    export https_proxy=127.0.0.1:8082
    if ping -q -c 1 -W 1 github.com >/dev/null ; then
      d3bug error "Check your internet connection. Exiting..."
      exit 1
    else
      d3gub info "Internet found behing Qubes Proxy. Resuming update..."
    fi
  fi

  d3bug info "Updating..."

  if suricata-update --output "$_PROJECT_DIR_CONF" \
                     --config "$_SURICATA_CONFIG" \
                     --data-dir "$_PROJECT_DIR_CONF" \
                     --no-test >/dev/null ; then
    if suricatasc -c ruleset-reload-nonblocking ; then
      d3bug info "Rules reloaded"
    else
      d3bug error "New rules can not be applied. Exiting..."
      exit 1
    fi

    echo "$(date +"%Y-%m-%d")" > "$_SURICATA_UPDATE_TIMESTAMP"
    d3bug info "Update finished."
  else
    d3bug error "Error updating Suricata rules. Exiting..."
    exit 1
  fi

}
export -f updateSuricataRules


function checkSuricataRules() {
  d3bug

  if [[ -f $_SURICATA_UPDATE_TIMESTAMP ]]; then
    if [[ $(cat $_SURICATA_UPDATE_TIMESTAMP) =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
      export lastUpdate="$((($(date +%s)-$(date +%s --date $(cat $_SURICATA_UPDATE_TIMESTAMP)))/(3600*24)))"
      #d3bug info "Rules old $lastUpdate days"
      if [[ "$lastUpdate" -gt "$_SURICATA_OUTDATE" ]]; then
        d3bug error "Rules to old"
        updateSuricataRules
      else
        d3bug info "Rules old $lastUpdate days. No need to update."
      fi
    else
        d3bug error "Rules never updated. Updating..."
        updateSuricataRules
    fi
  else
    d3bug error "Timestamp not found. Updating..."
    updateSuricataRules
  fi

}
export -f checkSuricataRules


function startSuriDaemon() {
  d3bug

  d3bug info "Starting $_PROJECT_NAME $_PROJECT_VER"

  xdg-icon-resource install --context mimetypes \
                            --size 48 \
                            "$_PROJECT_ICON_ACTIVE" \
                            "$_PROJECT_NAME-active"


  xdg-icon-resource install --context mimetypes \
                            --size 48 \
                            "$_PROJECT_ICON_INACTIVE" \
                            "$_PROJECT_NAME-inactive"

  d3bug info "Icons created"

  exec -a "$_PROJECT_NAME-$_PROJECT_VER" \
    yad --notification --no-middle --listen \
      --text="$_PROJECT_NAME v$_PROJECT_VER" \
      --image="$_PROJECT_NAME-inactive" \
      --separator="|" \
      --menu="${suriTrayMenuList:-Exit!bash -c exitSuriGUI}" \
      --command="bash -c suriOnClick" <&3 &

  d3bug info "Daemon started"
}
export -f startSuriDaemon


createProjectPipe

checkSuricataRules
checkSuricataService
[[ $suricataServiceStatus != "active" ]] && startSuricataService
startSuriDaemon

sleep 7

while [[ -e $_PROJECT_PIPE ]]; do
  sleep 10
  checkSuricataService
  # make while true as while suriActive???
done
